<style>
    .cmd-status-bar {
        font-family: "Source Sans Pro", sans-serif;
        padding: 10px 12px;
        border-radius: 6px;
        margin: 8px 0;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }
    .cmd-status-empty {
        background: #fff3cd;
        border-color: #ffc107;
        color: #856404;
    }
    .cmd-status-partial {
        background: #cce5ff;
        border-color: #007bff;
        color: #004085;
    }
    .cmd-status-valid {
        background: #d4edda;
        border-color: #28a745;
        color: #155724;
    }
    .cmd-status-icon {
        font-size: 16px;
        min-width: 18px;
    }
    .cmd-status-text {
        flex: 1;
    }
    .cmd-status-hint {
        font-size: 11px;
        opacity: 0.85;
    }
</style>
<div class="cmd-status-bar cmd-status-empty" id="cmd-status-bar">
    <span class="cmd-status-icon" id="cmd-status-icon">‚ö†Ô∏è</span>
    <span class="cmd-status-text" id="cmd-status-text">{{EMPTY_MESSAGE}}</span>
    <span class="cmd-status-hint" id="cmd-status-hint">See Help for command formats</span>
</div>

<script>
    (function() {
        // Include shared validation code
        {{SHARED_JS}}

        const V = ORRG_VALIDATION;
        const M = V.messages;

        const statusBar = document.getElementById('cmd-status-bar');
        const statusIcon = document.getElementById('cmd-status-icon');
        const statusText = document.getElementById('cmd-status-text');
        const statusHint = document.getElementById('cmd-status-hint');

        // Find and control the Execute button in parent document
        function setExecuteButtonState(enabled) {
            try {
                const buttons = window.parent.document.querySelectorAll('button');
                for (const btn of buttons) {
                    if (btn.innerText && btn.innerText.includes('Execute Command')) {
                        // Hide button when query is not valid, show when valid
                        btn.style.display = enabled ? '' : 'none';
                        btn.disabled = !enabled;
                        break;
                    }
                }
            } catch (e) {
                // Ignore cross-origin or access errors
            }
        }

        function updateStatus(text) {
            if (!statusBar || !statusIcon || !statusText || !statusHint) return;

            const trimmed = text.trim();

            if (!trimmed || trimmed.length === 0) {
                statusBar.className = 'cmd-status-bar cmd-status-empty';
                statusIcon.textContent = '‚ö†Ô∏è';
                statusText.textContent = M.empty;
                statusHint.textContent = 'See Help for command formats';
                setExecuteButtonState(false);
                return;
            }

            if (trimmed.length < 10) {
                statusBar.className = 'cmd-status-bar cmd-status-empty';
                statusIcon.textContent = '‚úèÔ∏è';
                statusText.textContent = M.typing;
                statusHint.textContent = 'Min 10 characters';
                setExecuteButtonState(false);
                return;
            }

            const lower = trimmed.toLowerCase();
            const cmdType = V.detectCommandType(lower);

            // World Events progressive validator is rendered in Help ‚Üí World Events tab,
            // not in the status bar. Here we only provide a lightweight hint.
            if (cmdType.hasWorldEvents) {
                statusBar.className = 'cmd-status-bar cmd-status-partial';
                statusIcon.textContent = 'üåç';
                statusText.textContent = 'World Events command detected.';
                statusHint.textContent = M.seeHelp('World Events');
                // Let backend parser decide; still require user to press Execute.
                setExecuteButtonState(true);
                return;
            }

            if (cmdType.hasVerb && cmdType.hasReverse) {
                // Validate as Reverse Range Ring using shared validator
                const result = V.validateReverse(lower);

                if (result.allExact) {
                    statusBar.className = 'cmd-status-bar cmd-status-valid';
                    statusIcon.textContent = '';
                    statusText.textContent = M.validatorValid;
                    statusHint.textContent = '';
                    setExecuteButtonState(true);
                } else if (result.allValid) {
                    // Fuzzy match - show warning, require exact match
                    statusBar.className = 'cmd-status-bar cmd-status-partial';
                    statusIcon.textContent = '‚ö†Ô∏è';
                    statusText.textContent = M.validatorFuzzy;
                    statusHint.textContent = '';
                    setExecuteButtonState(false);
                } else {
                    statusBar.className = 'cmd-status-bar cmd-status-empty';
                    statusIcon.textContent = '';
                    statusText.textContent = `‚ö†Ô∏è ${M.reverseFormat} ${M.seeHelp(result.toolName)}`;
                    statusHint.textContent = '';
                    setExecuteButtonState(false);
                }
            } else if (cmdType.hasVerb && cmdType.hasSingle) {
                // Validate as Single Range Ring using shared validator
                const result = V.validateSingle(lower);

                if (result.allExact) {
                    statusBar.className = 'cmd-status-bar cmd-status-valid';
                    statusIcon.textContent = '';
                    statusText.textContent = M.validatorValid;
                    statusHint.textContent = '';
                    setExecuteButtonState(true);
                } else if (result.allValid) {
                    // Fuzzy match - show warning, require exact match
                    statusBar.className = 'cmd-status-bar cmd-status-partial';
                    statusIcon.textContent = '‚ö†Ô∏è';
                    statusText.textContent = M.validatorFuzzy;
                    statusHint.textContent = '';
                    setExecuteButtonState(false);
                } else {
                    statusBar.className = 'cmd-status-bar cmd-status-empty';
                    statusIcon.textContent = '';
                    statusText.textContent = `‚ö†Ô∏è ${M.singleFormat} ${M.seeHelp(result.toolName)}`;
                    statusHint.textContent = '';
                    setExecuteButtonState(false);
                }
            } else if (cmdType.hasVerb && cmdType.hasMultiple) {
                const result = V.validateMultiple(lower);

                if (result.allExact) {
                    statusBar.className = 'cmd-status-bar cmd-status-valid';
                    statusIcon.textContent = '';
                    statusText.textContent = M.validatorValid;
                    statusHint.textContent = '';
                    setExecuteButtonState(true);
                } else if (result.allValid) {
                    // Fuzzy match - show warning, require exact match
                    statusBar.className = 'cmd-status-bar cmd-status-partial';
                    statusIcon.textContent = '‚ö†Ô∏è';
                    statusText.textContent = M.validatorFuzzy;
                    statusHint.textContent = '';
                    setExecuteButtonState(false);
                } else {
                    statusBar.className = 'cmd-status-bar cmd-status-empty';
                    statusIcon.textContent = '';
                    statusText.textContent = `‚ö†Ô∏è ${M.multipleFormat} ${M.seeHelp(result.toolName)}`;
                    statusHint.textContent = '';
                    setExecuteButtonState(false);
                }
            } else if (cmdType.hasVerb && cmdType.hasMinimum) {
                const result = V.validateMinimum(lower);

                if (result.sameLocation) {
                    statusBar.className = 'cmd-status-bar cmd-status-empty';
                    statusIcon.textContent = '';
                    statusText.textContent = '‚ùå Location A and Location B must be different! Cannot calculate distance to the same location.';
                    statusHint.textContent = '';
                    setExecuteButtonState(false);
                } else if (result.allExact) {
                    statusBar.className = 'cmd-status-bar cmd-status-valid';
                    statusIcon.textContent = '';
                    statusText.textContent = M.validatorValid;
                    statusHint.textContent = '';
                    setExecuteButtonState(true);
                } else if (result.allValid) {
                    // Fuzzy match - show warning, require exact match
                    statusBar.className = 'cmd-status-bar cmd-status-partial';
                    statusIcon.textContent = '‚ö†Ô∏è';
                    statusText.textContent = M.validatorFuzzy;
                    statusHint.textContent = '';
                    setExecuteButtonState(false);
                } else {
                    statusBar.className = 'cmd-status-bar cmd-status-empty';
                    statusIcon.textContent = '';
                    statusText.textContent = `‚ö†Ô∏è ${M.minimumFormat} ${M.seeHelp(result.toolName)}`;
                    statusHint.textContent = '';
                    setExecuteButtonState(false);
                }
            } else if (cmdType.hasCustomPoi) {
                const result = V.validateCustomPoi(lower);

                if (result.allExact) {
                    statusBar.className = 'cmd-status-bar cmd-status-valid';
                    statusIcon.textContent = '';
                    statusText.textContent = M.validatorValid;
                    statusHint.textContent = '';
                    setExecuteButtonState(true);
                } else if (result.allValid && result.hasFuzzy) {
                    // Fuzzy match - show warning, require exact match
                    statusBar.className = 'cmd-status-bar cmd-status-partial';
                    statusIcon.textContent = '‚ö†Ô∏è';
                    statusText.textContent = M.validatorFuzzy;
                    statusHint.textContent = '';
                    setExecuteButtonState(false);
                } else if (result.partialValid) {
                    statusBar.className = 'cmd-status-bar cmd-status-empty';
                    statusIcon.textContent = '';
                    statusText.textContent = '‚ö†Ô∏è Provide lat lon and range (min-max or max) with unit km/mi; separate POIs by semicolons/brackets.';
                    statusHint.textContent = M.customPoiRedirect;
                    setExecuteButtonState(false);
                } else {
                    statusBar.className = 'cmd-status-bar cmd-status-partial';
                    statusIcon.textContent = '‚ùì';
                    statusText.textContent = 'Enter custom POI: e.g., "Custom POIs: [Name lat lon 300-1200 km]; [Name lat lon 800 mi]"';
                    statusHint.textContent = M.customPoiRedirect;
                    setExecuteButtonState(false);
                }
            } else if (cmdType.hasVerb && cmdType.hasTrajectory) {
                const result = V.validateTrajectory(lower);

                if (result.allExact) {
                    statusBar.className = 'cmd-status-bar cmd-status-valid';
                    statusIcon.textContent = '';
                    statusText.textContent = M.validatorValid;
                    statusHint.textContent = '';
                    setExecuteButtonState(true);
                } else if (result.allValid) {
                    statusBar.className = 'cmd-status-bar cmd-status-partial';
                    statusIcon.textContent = '‚ö†Ô∏è';
                    statusText.textContent = M.validatorFuzzy;
                    statusHint.textContent = '';
                    setExecuteButtonState(false);
                } else if (result.partialValid) {
                    statusBar.className = 'cmd-status-bar cmd-status-empty';
                    statusIcon.textContent = '';
                    statusText.textContent = '‚ö†Ô∏è Format: Show launch trajectory from [Origin] to [Destination]';
                    statusHint.textContent = M.trajectoryRedirect;
                    setExecuteButtonState(false);
                } else {
                    statusBar.className = 'cmd-status-bar cmd-status-partial';
                    statusIcon.textContent = 'üöÄ';
                    statusText.textContent = 'Enter: "Show launch trajectory from [Origin] to [Destination]"';
                    statusHint.textContent = M.trajectoryRedirect;
                    setExecuteButtonState(false);
                }
            } else if (cmdType.hasVerb) {
                statusBar.className = 'cmd-status-bar cmd-status-partial';
                statusIcon.textContent = 'üîç';
                statusText.textContent = M.unrecognized;
                statusHint.textContent = 'See Help for available command formats';
                setExecuteButtonState(false);
            } else {
                // No recognized command type - could be a general query, allow execution
                statusBar.className = 'cmd-status-bar cmd-status-partial';
                statusIcon.textContent = '‚ùì';
                statusText.textContent = M.query;
                statusHint.textContent = M.queryHint;
                setExecuteButtonState(true);
            }
        }

        function attachListener() {
            const textareas = window.parent.document.querySelectorAll('textarea');
            for (const ta of textareas) {
                if (ta.placeholder && ta.placeholder.includes('Type a question')) {
                    ta.addEventListener('input', function(e) {
                        updateStatus(e.target.value);
                    });
                    // Initial validation - also sets button state
                    updateStatus(ta.value);
                    return true;
                }
            }
            // Button should be disabled until validation passes
            setExecuteButtonState(false);
            return false;
        }

        // Also disable button immediately on script load
        setExecuteButtonState(false);

        let attempts = 0;
        const maxAttempts = 20;
        const tryAttach = setInterval(function() {
            attempts++;
            if (attachListener() || attempts >= maxAttempts) {
                clearInterval(tryAttach);
            }
        }, 200);
    })();
</script>